<!DOCTYPE html>
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>固收日报发布系统</title>
	<!-- <link rel="stylesheet" href="../../css/bootstrap.min.css"> -->
	<link rel="stylesheet" href="../../css/font-awesome.min.css">
	<link rel="stylesheet" href="../../plugins/jqgrid/ui.jqgrid-bootstrap.css">
	<link rel="stylesheet" href="../../plugins/ztree/css/metroStyle/metroStyle.css">
	<link rel="stylesheet" href="../../css/main.css">
	
	<script type="text/javascript" src="../../js/jquery-1.4.4.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.ztree.core.js"></script>
    <script type="text/javascript" src="../../js/jquery.ztree.excheck.js"></script>
	<script src="../../libs/jquery.min.js"></script>
	<script src="../../plugins/layer/layer.js"></script>
	<script src="../../libs/bootstrap.min.js"></script>
	<script src="../../libs/vue.min.js"></script>
	<script src="../../plugins/jqgrid/grid.locale-cn.js"></script>
	<script src="../../plugins/jqgrid/jquery.jqGrid.min.js"></script>
	<script src="../../plugins/ztree/jquery.ztree.all.min.js"></script>
	<script type="text/javascript" src="../../js/echarts.js"></script>
	
	<script src="../../libs/dom-to-image.js"></script>
	<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
	
	<script src="../../libs/html2canvas.js"></script>
    <!-- <script type="text/javascript" src="../../js/common.js"></script> -->
	
  <link rel="stylesheet" href="../../css/reset.css">
  <link rel="stylesheet" href="../../css/weixin.css">
</head>
<body>
  <div class="container" id = "test1">
    <div class="form1">
      <h3>银行间每日债券借贷</h3>
      <table id="table1">
        <thead>
          <!-- 
          <tr>
            <th>债券类型</th>
            <th>债券简称</th>
            <th>债券代码</th>
            <th>待偿期（年）</th>
            <th>最新买价%</th>
            <th>当日加提成当成交价格</th>
            <th>今日累计成交量（万元）</th>
          </tr>
           -->
        </thead>
        <tbody>
          <!-- 
          <tr>
            <td>SuZhou</td>
            <td>11111</td>
            <td>22222</td>
            <td>333</td>
            <td>666</td>
            <td>777</td>
            <td>888</td>
          </tr>
           -->
        </tbody>
      </table>
      
      <div id = "img1">  	
		<img id="myIMG" src= "./chart.png"/>		
      </div>
      <img src="https://static.oschina.net/uploads/space/2018/0103/095025_6PJt_3070088.png" />
      
      
    </div>
    
    <div class="form2">
      <h3>国债期货当日结算价</h3>
      <table id="table2">
        <thead>
          <!--
          <tr>
            <th>债券类型</th>
            <th>债券简称</th>
            <th>债券代码</th>
            <th>待偿期（年）</th>
            <th>最新买价%</th>
            <th>当日加提成当成交价格</th>
            <th>今日累计成交量（万元）</th>
          </tr>
          -->
        </thead>
        <tbody>
          <!-- 
          <tr>
            <td>SuZhou</td>
            <td>11111</td>
            <td>22222</td>
            <td>333</td>
            <td>666</td>
            <td>777</td>
            <td>888</td>
          </tr>
           -->
        </tbody>
      </table>
    </div>
    
	<div class="echart1">
    	<h3 class="echart-title">结算价格折线图</h3>
      	<div id="main1" style="height:400px;width:80%;margin:0 auto;"></div>
    </div>
    
    <div class="form3">
      <h3>国债期货品种排名</h3>
      <table id="table3">
        <thead>
          <!-- 
          <tr>
            <th>债券类型</th>
            <th>债券简称</th>
            <th>债券代码</th>
            <th>待偿期（年）</th>
            <th>最新买价%</th>
            <th>当日加提成当成交价格</th>
            <th>今日累计成交量（万元）</th>
          </tr>
           -->
        </thead>
        <tbody>
          <!-- 
          <tr>
            <td>SuZhou</td>
            <td>11111</td>
            <td>22222</td>
            <td>333</td>
            <td>666</td>
            <td>777</td>
            <td>888</td>
          </tr>
           -->
        </tbody>
      </table>
    </div>
</div>
</body>
  <!-- <script src="../../js/echarts.js"></script>  -->
  <script src="../../js/weixin.js"></script>
  <script>
//请求前缀
  var baseURL = "/renren-fastplus/";
	
	// 合并列
	//基于Jquery写法 
	//函数说明：合并指定表格（表格id为_w_table_id）指定列（列数为_w_table_colnum）的相同文本的相邻单元格  
	//参数说明：_w_table_id 为需要进行合并单元格的表格的id。如在HTMl中指定表格 id="data" ，此参数应为 #data   
	//参数说明：_w_table_colnum 为需要合并单元格的所在列。为数字，从最左边第一列为1开始算起。  
	function _w_table_rowspan(_w_table_id, _w_table_colnum) {  
	  _w_table_firsttd = "";  
	  _w_table_currenttd = "";  
	  _w_table_SpanNum = 0;  
	  _w_table_Obj = $(_w_table_id + " tr td:nth-child(" + _w_table_colnum + ")");
	  _w_table_Obj.each(function (i) {
	    if (i == 0) {  
	      _w_table_firsttd = $(this);  
	      _w_table_SpanNum = 1;  
	    } else {  
	      _w_table_currenttd = $(this);  
	      if (_w_table_firsttd.text() == _w_table_currenttd.text()) {//这边注意不是val（）属性，而是text（）属性  
	          _w_table_SpanNum++;  
	          _w_table_currenttd.hide(); //remove();  
	          _w_table_firsttd.attr("rowSpan", _w_table_SpanNum);  
	      } else {  
	          _w_table_firsttd = $(this);  
	          _w_table_SpanNum = 1;  
	      }  
	    }  
	  });  
	}  
	// _w_table_rowspan("#subtable",1);

	// 合并行
	//函数说明：合并指定表格（表格id为_w_table_id）指定行（行数为_w_table_rownum）的相同文本的相邻单元格  
	//参数说明：_w_table_id 为需要进行合并单元格的表格id。如在HTMl中指定表格 id="data" ，此参数应为 #data   
	//参数说明：_w_table_rownum 为需要合并单元格的所在行。其参数形式请参考jQuery中nth-child的参数。  
	//如果为数字，则从最左边第一行为1开始算起。  
	//"even" 表示偶数行  
	//"odd" 表示奇数行  
	//"3n+1" 表示的行数为1、4、7、10.......  
	//参数说明：_w_table_maxcolnum 为指定行中单元格对应的最大列数，列数大于这个数值的单元格将不进行比较合并。  
	//此参数可以为空，为空则指定行的所有单元格要进行比较合并。  
	function _w_table_colspan(_w_table_id, _w_table_rownum, _w_table_maxcolnum) {  
	  if (_w_table_maxcolnum == void 0) { 
	    _w_table_maxcolnum = 0; 
	  }  
	  _w_table_firsttd = "";  
	  _w_table_currenttd = "";  
	  _w_table_SpanNum = 0;  
	  $(_w_table_id + " tr:nth-child(" + _w_table_rownum + ")").each(function (i) {  
	      _w_table_Obj = $(this).children();  
	      _w_table_Obj.each(function (i) {  
	          if (i == 0) {  
	              _w_table_firsttd = $(this);  
	              _w_table_SpanNum = 1;  
	          } else if ((_w_table_maxcolnum > 0) && (i > _w_table_maxcolnum)) {  
	              return "";  
	          } else {  
	              _w_table_currenttd = $(this);  
	              if (_w_table_firsttd.text() == _w_table_currenttd.text()) {  
	                  _w_table_SpanNum++;  
	                  _w_table_currenttd.hide(); //remove();  
	                  _w_table_firsttd.attr("colSpan", _w_table_SpanNum);  
	              } else {  
	                  _w_table_firsttd = $(this);  
	                  _w_table_SpanNum = 1;  
	              }  
	          }  
	      });  
	  });  
	} 
	
	function _w_table_rowspanTh(_w_table_id, _w_table_colnum) {  
		  _w_table_firsttd = "";  
		  _w_table_currenttd = "";  
		  _w_table_SpanNum = 0;  
		  _w_table_Obj = $(_w_table_id + " tr th:nth-child(" + _w_table_colnum + ")");
		  _w_table_Obj.each(function (i) {
		    if (i == 0) {  
		      _w_table_firsttd = $(this);  
		      _w_table_SpanNum = 1;  
		    } else {  
		      _w_table_currenttd = $(this);  
		      if (_w_table_firsttd.text() == _w_table_currenttd.text()) {//这边注意不是val（）属性，而是text（）属性  
		          _w_table_SpanNum++;  
		          _w_table_currenttd.hide(); //remove();  
		          _w_table_firsttd.attr("rowSpan", _w_table_SpanNum);  
		      } else {  
		          _w_table_firsttd = $(this);  
		          _w_table_SpanNum = 1;  
		      }  
		    }  
		  });  
		}
  
	$(function(){
		var	paramdate = getQueryString("dt");
		var	stype = getQueryString("stype");
		//var	paramdate = '2016-06-15';
		var paramswx = {
				paramdate: paramdate,
				stype: stype
		}
		console.log(baseURL + "api/look");
		if(paramdate != null && paramdate !=''){
			//指定某日的日报
			$.ajax({
				type: "POST",
			    //url: baseURL + "generator/newspaper/look",
			    url: baseURL + "api/look",
                contentType: "application/json",
			    data: JSON.stringify(paramswx),
			    async: false,
			    success: function(r){
					if(r.code == 0){
						//$(".form1 h3").html(r.newspaperEntity.paramdate + "银行间每日债券借贷");
						//$(".form2 h3").html(r.newspaperEntity.paramdate + "国债期货当日结算价");
						//$(".form3 h3").html(r.newspaperEntity.paramdate + "国债期货品种排名");
						// ============== 表格：银行间每日债券借贷  ============== 
						var str = ""; var strTd = "";
						if(r.newspaperEntity.stype == '1' || r.newspaperEntity.stype == '2'){
							str = ""; strTd = "";
							$(".form1 h3").html(r.newspaperEntity.paramdate + "银行间每日债券借贷");
							if(null !=r.listZQJD && r.listZQJD != undefined && r.listZQJD.length > 0){
								str = "<tr>" +
										  "<th>委托日期</th>" +
										  "<th>标的券代码</th>" + 
										  "<th>标的券名称</th>" + 
								          "<th>加权平均费率(%)</th>" +
								          "<th>成交量(亿元)</th>" +
							          "</tr>";
								$("#table1 thead").html('');
								$("#table1 thead").html(str);
								
								$.each(r.listZQJD,function(index, item){   
								    strTd += "<tr>" +
									    		"<td>" + item.trddate + "</td>" +
									    		"<td>" + item.uICode + "</td>" +
									    		"<td>" + item.bName + "</td>" +
									    		"<td>" + item.weightedAverageRate + "</td>" +
									    		"<td>" + item.volume + "</td>" +
								    		"</tr>";
								})  															
								$("#table1 tbody").html('');
								$("#table1 tbody").html(strTd);
								
								/* html2canvas(document.getElementById("form1")).then(function(canvas) {
								    document.body.appendChild(canvas);
								}); */

								  html2canvas(document.getElementById("test1"),{
								    onrendered: function(canvas) {
								        var imgURL=canvas.toDataURL("image/png");
								        alert(imgURL);
								        $('#myIMG').attr("src",imgURL);
								    }
								}); 
								
								   /* var node = document.getElementById('table1');
							        domtoimage.toPng(node,{ quality: 0.95 })
							                  .then(function (dataUrl) {
							                      var img = new Image();
							                      img.src = dataUrl;	
							                      document.getElementById("img1").appendChild(img);
													img.onclick=function(){
														 alert(img.src);
														 wx.previewImage({
														    current: img.src,
														}); 												           
													} 
							                  }); */  
							        
							}else{
								$(".form1 h3").html(r.newspaperEntity.paramdate + "银行间每日债券借贷 无数据");
							}
						}else{
							$(".form1 h3").html('');
						}						
						// ============== 表格：国债期货当日结算价  ==============
						if(r.newspaperEntity.stype == '1' || r.newspaperEntity.stype == '2'){
							str = ""; strTd = "";
							$(".form2 h3").html(r.newspaperEntity.paramdate + "国债期货当日结算价");
							if(null !=r.listVCBONDFUTURESEODPRICES && r.listVCBONDFUTURESEODPRICES != undefined && r.listVCBONDFUTURESEODPRICES.length > 0){
								str = "<tr>" +
										  "<th>交易日</th>" +
										  "<th>合约</th>" + 
										  "<th>开盘价</th>" + 
								          "<th>最高价</th>" +
								          "<th>最低价</th>" +
								          "<th>收盘价</th>" +
								          "<th>结算价</th>" +
								          "<th>成交量</th>" +
								          "<th>持仓量</th>" +
								          "<th>涨跌(元)-涨跌幅%</th>" +
								          "<th>最后交易日期</th>" +
							          "</tr>";
							    $("#table2 thead").html('');
								$("#table2 thead").html(str);
								$.each(r.listVCBONDFUTURESEODPRICES,function(index, item){ 
									    strTd += "<tr>" +
										    		"<td>" + item.tradeDt + "</td>" +
										    		"<td>" + item.sInfoWindcode + "</td>" +
										    		"<td>" + item.sDqOpen + "</td>" +
										    		"<td>" + item.sDqHigh + "</td>" +
										    		"<td>" + item.sDqLow + "</td>" +
										    		"<td>" + item.sDqClose + "</td>" +
										    		"<td>" + item.sDqSettle + "</td>" +
										    		"<td>" + item.sDqVolume + "</td>" +
										    		"<td>" + item.sDqOi + "</td>" +
										    		"<td>" + item.sDqChange + "</td>" +
										    		"<td style='text-align:left;'>" + item.sInfoDelistdate + "</td>" +
									    		"</tr>";
								})
								$("#table2 tbody").html('');
								$("#table2 tbody").html(strTd);
							}else{
								$(".form2 h3").html(r.newspaperEntity.paramdate + "国债期货当日结算价 无数据");
							}
						}else{
							$(".form2 h3").html('');
						}
						
						// ============== 折线图：国债期货当日结算价  ==============
					    if(r.newspaperEntity.stype == '1' || r.newspaperEntity.stype == '2'){
					    	var myChart1 = echarts.init(document.getElementById('main1')); 
					    	option1 = {
					    	    //标记
					    	    legend: {
					    	        data:[r.namehy + '价格走势'],
					    	    },
					    	    // 提示
					    	    tooltip : {
					    	        trigger: 'axis'
					    	    },
					    	      calculable : true,

					    	      xAxis : [
					    	          {
					    	              axisLabel:{
					    	              interval:0
					    	              },
					    	              axisLine:{
					    	                lineStyle :{
					    	                    color: '#CECECE'
					    	                }
					    	              },
					    	              type : 'category',
					    	              boundaryGap : false,
					    	              data : r.dateLists
					    	      }],
					    	      yAxis : [
					    	          {

					    	              type : 'value',
					    	              min: r.minvalue,
					    	              max: r.maxvalue,
					    	              axisLabel : {
					    	                formatter: function(value,index){
					    	                  return value.toFixed(1)
					    	                }
					    	              },
					    	              axisLine:{
					    	                  lineStyle :{
					    	                      color: '#CECECE'
					    	                  }
					    	              }
					    	          }
					    	      ],
					    	      series : [
					    	          {
					    	              name: r.namehy + '价格走势',
					    	              type:'line',
					    	              symbol:'emptyCircle',
					    	              smooth: 0.2,
					    	              color:['#66AEDE'],
					    	              data:r.priceLists,
					    	          }
					    	      ]

					    	};
					    	myChart1.setOption(option1); 
					    }else{
					    	$(".echart1").html('');
					    }
							
						// ============== 表格：国债期货品种排名  ==============	
						if(r.newspaperEntity.stype == '3'){
							if(null != r.listVCBONDFUTURESPOSITIONSD && r.listVCBONDFUTURESPOSITIONSD != undefined && r.listVCBONDFUTURESPOSITIONSD.length > 0){
								str = ""; strTd = "";
								$(".form2").html('');
								var all = "<h3>" + r.newspaperEntity.paramdate + "国债期货品种排名</h3>" ;
								$.each(r.newspaperEntity.sInfoWindcodes,function(index1, item1){ 
									str = "<div class='remarks' style='margin-top: 12px;'><div class='left'>合约：" + item1 + "</div>" + 
								          "<div class='right'>交易日期：" + r.newspaperEntity.paramdate + "</div></div>" +
									      "<table class='table3'>" +
								          	"<thead class='main-title'>" +
								            	"<th colspan='4'>成交量排名</th>" +
								            	"<th colspan='4'>持买量排名</th>" +
								            	"<th colspan='4'>持卖量排名</th>" +
								            "</thead>" +
								            "<thead class='sub-title'>" +
											  "<tr>" +
											  	  //"<th>日期</th>" +
												  //"<th>合约</th>" + 
												  "<th>名次</th>" + 
												  "<th>会员简称</th>" + 
												  "<th>成交量</th>" + 
												  "<th>比上交易日增减</th>" + 
												  "<th>名次</th>" + 
												  "<th>会员简称</th>" + 
												  "<th>持买单量</th>" + 
												  "<th>比上交易日增减</th>" + 
												  "<th>名次</th>" + 
												  "<th>会员简称</th>" + 
												  "<th>持卖单量</th>" + 
												  "<th>比上交易日增减</th>" + 
											  "</tr>" +
											"</thead><tbody>";
								    //合并列
									//_w_table_colspan(".table3",1,13);
								    all += str;
								    strTd = "";
								    var num1=0,num2=0,num3=0,num4=0,num5=0,num6=0;
								    var num1str='',num2str='',num3str='',num4str='',num5str='',num6str='';
									$.each(r.listVCBONDFUTURESPOSITIONSD,function(index, item){ 
										if(item.sInfoWindcode == item1){
											num1 += item.cJl;
											num2 += item.cJlbh;
											num3 += item.cBl;
											num4 += item.cBlbh;
											num5 += item.cSl;
											num6 += item.cSlbh;
										    strTd += "<tr>" +
											    		//"<td style='text-align:left;'>" + item.tradeDt + "</td>" +
											    		//"<td>" + item.sInfoWindcode + "</td>" +
											    		"<td>" + item.fsInfoRank + "</td>" +
											    		"<td>" + item.cJmem + "</td>" +
											    		"<td>" + item.cJl + "</td>" +
											    		"<td>" + item.cJlbh + "</td>" +
											    		"<td>" + item.fsInfoRank + "</td>" +
											    		"<td>" + item.cBmem + "</td>" +
											    		"<td>" + item.cBl + "</td>" +
											    		"<td>" + item.cBlbh + "</td>" +
											    		"<td>" + item.fsInfoRank + "</td>" +
											    		"<td>" + item.cSmem + "</td>" +
											    		"<td>" + item.cSl + "</td>" +
											    		"<td>" + item.cSlbh + "</td>" +
										    		"</tr>";
										}
										all += strTd;
										strTd = "";
									}) 
									num1str = parseFloat(num1) > 0? '<font color="#008000">' + num1 + '</font>' : '<font color="#ff0000">' + num1 + '</font>';
									num2str = parseFloat(num2) > 0? '<font color="#008000">' + num2 + '</font>' : '<font color="#ff0000">' + num2 + '</font>';
									num3str = parseFloat(num3) > 0? '<font color="#008000">' + num3 + '</font>' : '<font color="#ff0000">' + num3 + '</font>';
									num4str = parseFloat(num4) > 0? '<font color="#008000">' + num4 + '</font>' : '<font color="#ff0000">' + num4 + '</font>';
									num5str = parseFloat(num5) > 0? '<font color="#008000">' + num5 + '</font>' : '<font color="#ff0000">' + num5 + '</font>';
									num6str = parseFloat(num6) > 0? '<font color="#008000">' + num6 + '</font>' : '<font color="#ff0000">' + num6 + '</font>';
									all += '<tr>' + 
						            	   	'<td>合计</td>' + 
								            '<td></td>' + 
								            '<td>' + num1str + '</td>' + 
								            '<td>' + num2str + '</td>' + 
								            '<td></td>' + 
								            '<td></td>' + 
								            '<td>' + num3str + '</td>' + 
								            '<td>' + num4str + '</td>' + 
								            '<td></td>' + 
								            '<td></td>' + 
								            '<td>' + num5str + '</td>' + 
								            '<td>' + num6str + '</td>' + 
								          '</tr>';
									num1=0; num2=0; num3=0; num4=0; num5=0; num6=0;
									num1str=''; num2str=''; num3str=''; num4str=''; num5str=''; num6str='';
									all += "</tbody></table>";
								})
								all += "</div></br>";
								$(".form3").html(all)
							}else{
								$(".form3 h3").html(r.newspaperEntity.paramdate + "国债期货品种排名 无数据");
							}
						}else{
							$(".form3 h3").html('');
						}
				
						/*  var imgsurl=[];
						var nowurl='';
						var imgObj=$("img");
						for(var i=0;i<imgObj.length;i++){
							imgsurl[i]=imgObj[i].src;
							imgObj[i].onclick=function(){
								 alert("ok...");
								nowurl=this.src; 
								 wx.previewImage({
								    current: nowurl,
								    urls: imgsurl
								}); 
						          WeixinJSBridge.invoke("imagePreview",{
						              "urls":imgsurl,
						              "current":nowurl
						              });
							}
						} */
						
					}else{
						alert(r.msg);
					}
				}
			});
		}else{
			alert("非法请求");
		}
		
		
		
		
		
    	// 表格1
        _w_table_rowspan("#table1",1);
        _w_table_colspan("#table1",1,1);
        // 表格2
        _w_table_rowspanTh("#table2",1);
        _w_table_rowspan("#table2",1);
        _w_table_colspan("#table2",1,1);
	});
	
	function getQueryString(name) {  
		var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");  
		var r = window.location.search.substr(1).match(reg);  
		if (r != null) return unescape(r[2]);  
		return null;  
	} 

  </script>
</html>